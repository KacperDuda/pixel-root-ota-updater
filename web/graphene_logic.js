// @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt MIT
import*as e from"./fastboot/ffe7e270/fastboot.min.mjs";const t="https://releases.grapheneos.org",a={UNLOCK_BOOTLOADER:"unlock-bootloader",DOWNLOAD_RELEASE:"download-release",FLASH_RELEASE:"flash-release",LOCK_BOOTLOADER:"lock-bootloader",REMOVE_CUSTOM_KEY:"remove-custom-key"},n=1,o=2;let s=null;const r=async()=>{try{s=await navigator.wakeLock.request("screen"),console.log("Wake lock has been set"),s.addEventListener("release",async()=>{console.log("Wake lock has been released")})}catch(e){throw new Error(`${e.name}, ${e.message}`)}},i=async()=>{null!==s&&s.release().then(()=>{s=null})};function l({id:e,enabled:t}){const a=document.getElementById(`${e}-button`);return a.disabled=!t,a}document.addEventListener("visibilitychange",async()=>{null!==s&&"visible"===document.visibilityState&&await r()});let c=0,d=new e.FastbootDevice,u=new class{constructor(){this.db=null}async _wrapReq(e,t=null){return new Promise((a,n)=>{e.onsuccess=()=>{a(e.result)},e.oncomplete=()=>{a(e.result)},e.onerror=()=>{n(e.error)},null!==t&&(e.onupgradeneeded=t)})}async _wrapTransaction(e){return new Promise((t,a)=>{e.oncomplete=()=>{t(e.result)},e.onerror=()=>{a(e.error)},e.onabort=()=>{a(e.error)}})}async init(){null===this.db&&(this.db=await this._wrapReq(indexedDB.open("BlobStore",1),e=>{e.target.result.createObjectStore("files",{keyPath:"name"})}))}async saveFile(e,t){const a=this.db.transaction(["files"],"readwrite"),n=a.objectStore("files").add({name:e,blob:t});await Promise.all([this._wrapTransaction(a),this._wrapReq(n)])}async loadFile(e){try{return(await this._wrapReq(this.db.transaction("files").objectStore("files").get(e))).blob}catch{return null}}async close(){this.db.close()}async download(e,t=()=>{}){let a=e.split("/").pop(),n=await this.loadFile(a);if(null===n){console.log(`Downloading ${e}`);let n=await function(e,t){let a=new XMLHttpRequest;return a.open("GET",e),a.responseType="blob",a.send(),new Promise((e,n)=>{a.onload=()=>{200!==a.status?n(`${a.status} ${a.statusText}`):e(a.response)},a.onprogress=e=>{t(e.loaded/e.total)},a.onerror=()=>{n("Network request failed")}})}(e,t);console.log("File downloaded, saving..."),await this.saveFile(a,n),console.log("File saved")}else console.log(`Loaded ${a} from blob store, skipping download`);return n}},m=new class{#e;constructor(){this.#e=new Map}setEnabled(...e){e.forEach(e=>{this.#e.has(e)||this.#e.set(e,!0)})}setDisabled(...e){e.forEach(e=>this.#e.set(e,!1))}applyState(){this.#e.forEach((e,t)=>{l({id:t,enabled:e})}),this.#e.clear()}};async function w(e){d.isConnected||(e("Connecting to device..."),await d.connect())}const g=["rango","mustang","blazer","frankel","tegu","comet","komodo","caiman","tokay","akita","husky","shiba","felix","tangorpro","lynx","cheetah","panther","bluejay","raven","oriole","barbet","redfin","bramble","sunfish","coral","flame"],h=["sunfish","coral","flame"],b=["tegu","comet","komodo","caiman","tokay","akita","husky","shiba","felix","tangorpro","lynx","cheetah","panther","bluejay","raven","oriole","barbet","redfin","bramble"];function p(e){return!h.includes(e)}async function y(){let e=await d.getVariable("product");if(!g.includes(e))throw new Error(`device model (${e}) is not supported by the GrapheneOS web installer`);let a=await fetch(`${t}/${e}-stable`),n=(await a.text()).split(" ")[0];return[`${e}-${p(e)?"install":"factory"}-${n}.zip`,e]}async function f(){document.getElementById("flash-release-status").textContent="To continue flashing, reconnect the device by tapping here:";let e=document.getElementById("flash-reconnect-button"),t=document.getElementById("flash-release-progress");t.hidden=!0,e.hidden=!1,e.onclick=async()=>{await d.connect(),e.hidden=!0,t.hidden=!1}}function E(e,t){let a=document.getElementById(`${e}-status-container`),n=document.getElementById(`${e}-status`),o=document.getElementById(`${e}-progress`),s=(e,t)=>{null!==a&&(a.hidden=!1),n.className="",n.textContent=e,void 0!==t&&(o.hidden=!1,o.value=t)};l({id:e,enabled:!0}).onclick=async()=>{try{let e=await t(s);void 0!==e&&s(e)}catch(e){let t;throw t=e instanceof DOMException&&"QuotaExceededError"===e.name?"storage quota has been exceeded, you might not have enough space on your drive, or you're using incognito mode":"object"==typeof e&&null!=e.message&&""!==e.message?e.message:e.toString(),s(`Error: ${t}`),n.className="error-text",await i(),e}}}function v({state:e,active:t}){t?c|=e:c&=~e,function(){k(n)?m.setDisabled(a.DOWNLOAD_RELEASE):m.setEnabled(a.DOWNLOAD_RELEASE);let e=[a.DOWNLOAD_RELEASE,a.FLASH_RELEASE,a.LOCK_BOOTLOADER,a.REMOVE_CUSTOM_KEY];k(o)?m.setDisabled(...e):m.setEnabled(...e);m.applyState()}()}function k(e){return(c&e)===e}if(e.setDebugLevel(2),e.configureZip({workerScripts:{inflate:["/js/fastboot/ffe7e270/vendor/z-worker-pako.js","pako_inflate.min.js"]}}),"usb"in navigator)E(a.UNLOCK_BOOTLOADER,async function(t){if(await w(t),"yes"===await d.getVariable("unlocked"))return"Bootloader is already unlocked.";t("Unlocking bootloader...");try{await d.runCommand("flashing unlock")}catch(t){throw t instanceof e.FastbootError&&"FAIL"===t.status?new Error("Bootloader was not unlocked, please try again!"):t}return"Bootloader unlocking triggered successfully."}),E(a.DOWNLOAD_RELEASE,async function(e){await r(),await w(e),e("Finding latest release...");let[a]=await y();v({state:n,active:!0}),e(`Downloading ${a}...`),await u.init();try{await u.download(`${t}/${a}`,t=>{e(`Downloading ${a}...`,t)})}finally{v({state:n,active:!1}),await i()}e(`Downloaded ${a} release.`,1)}),E(a.FLASH_RELEASE,async function(t){await r(),await w(t),t("Finding latest release...");let[a,n]=await y();await u.init();let s=await u.loadFile(a);if(null===s)throw new Error("You need to download a release first!");if(t("Cancelling any pending OTAs..."),b.includes(n)){let e=await d.getVariable("snapshot-update-status");null!==e&&"none"!==e&&await d.runCommand("snapshot-update:cancel")}t("Flashing release..."),v({state:o,active:!0});try{await d.flashFactoryZip(s,!0,f,(a,n,o)=>{let s=e.USER_ACTION_MAP[a];t(`${s} ${"avb_custom_key"===n?"verified boot key":n}...`,o)}),h.includes(n)&&(t("Disabling UART..."),await d.runCommand("oem uart disable "),t("Erasing apdp..."),await d.runCommand("erase:apdp_a"),await d.runCommand("erase:apdp_b"),t("Erasing msadp..."),await d.runCommand("erase:msadp_a"),await d.runCommand("erase:msadp_b"))}finally{v({state:o,active:!1}),await i()}return`Flashed ${a} to device.`}),E(a.LOCK_BOOTLOADER,async function(t){await w(t),t("Locking bootloader...");try{await d.runCommand("flashing lock")}catch(t){throw t instanceof e.FastbootError&&"FAIL"===t.status?new Error("Bootloader was not locked, please try again!"):t}return"Bootloader locking triggered successfully."}),E(a.REMOVE_CUSTOM_KEY,async function(e){await w(e),e("Erasing key...");try{await d.runCommand("erase:avb_custom_key")}catch(e){throw console.log(e),e}return"Key erased."}),navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then(e=>{0!==e.quota&&e.quota<2097152e3&&(document.getElementById("quota-warning-text").hidden=!1)});else{console.log("WebUSB unavailable");for(const e in a){const t=a[e],n=document.getElementById(`${t}-status-container`),o=document.getElementById(`${t}-status`);null!==n&&(n.hidden=!1),o.className="error-text",o.innerHTML='Unavailable, as your browser doesn\'t support WebUSB. Please read the <a href="#prerequisites">prerequisites</a>.'}}window.addEventListener("beforeunload",e=>{0!==c&&(console.log("User tried to leave the page whilst unsafe to leave!"),e.returnValue="")});
// @license-end